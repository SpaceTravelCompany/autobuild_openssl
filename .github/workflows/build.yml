name: Build Libraries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-libraries-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Clang/LLVM
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "21.1.8"
        env: true
    - uses: ilammy/msvc-dev-cmd@v1
    - uses: ilammy/setup-nasm@v1

    - name: Download OpenSSL source
      id: download-openssl
      uses: ./.github/actions/download-openssl

    - name: Configure OpenSSL (Windows x64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: cmd
      run: |
        set CC=clang-cl
        perl Configure VC-WIN64A no-shared no-legacy --release /MT --prefix=${{ github.workspace }}/install/windows/x64

    - name: Build OpenSSL (Windows x64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: cmd
      run: |
        nmake
        type nul > ossl_static.pdb

    - name: Install OpenSSL (Windows x64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: cmd
      run: nmake install_sw

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libraries-windows
        path: install/**
        retention-days: 7

  build-libraries-windows-arm64:
    runs-on: windows-11-arm

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Clang/LLVM
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "21.1.8"
        env: true
    - uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64_arm64
    - uses: ilammy/setup-nasm@v1

    - name: Download OpenSSL source
      id: download-openssl
      uses: ./.github/actions/download-openssl

    - name: Configure OpenSSL (Windows ARM64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: cmd
      run: |
        set CC=clang-cl
        perl Configure VC-WIN64-ARM no-shared no-legacy --release /MT --prefix=${{ github.workspace }}/install/windows/arm64

    - name: Build OpenSSL (Windows ARM64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: cmd
      run: |
        nmake
        type nul > ossl_static.pdb

    - name: Install OpenSSL (Windows ARM64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: cmd
      run: nmake install_sw

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libraries-windows-arm64
        path: install/**
        retention-days: 7

  build-libraries-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Clang/LLVM
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "21.1.8"
        env: true

    - name: Setup cross-compilation environment
      uses: SpaceTravelCompany/My-Actions/setup-linux-cross@main

    - name: Download OpenSSL source
      id: download-openssl
      uses: ./.github/actions/download-openssl

    # --- x86_64 --- (--target not recognized by default)
    - name: Configure OpenSSL (Linux x86_64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: ./Configure linux-x86_64 no-shared no-legacy --release --prefix=${{ github.workspace }}/install/linux/x86_64 CFLAGS="--target=x86_64-linux-gnu"

    - name: Build & Install OpenSSL (Linux x86_64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- aarch64 ---
    - name: Configure OpenSSL (Linux aarch64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: ./Configure linux-aarch64 no-shared no-legacy --release --prefix=${{ github.workspace }}/install/linux/aarch64 CFLAGS="--target=aarch64-linux-gnu"

    - name: Build & Install OpenSSL (Linux aarch64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- riscv64 ---
    - name: Configure OpenSSL (Linux riscv64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: ./Configure linux64-riscv64 no-shared no-legacy --release --prefix=${{ github.workspace }}/install/linux/riscv64 CFLAGS="--target=riscv64-linux-gnu"

    - name: Build & Install OpenSSL (Linux riscv64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- i686 ---
    - name: Configure OpenSSL (Linux i686)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: ./Configure linux-x86-latomic no-shared no-legacy --release --prefix=${{ github.workspace }}/install/linux/i686 CFLAGS="--target=i686-linux-gnu"

    - name: Build & Install OpenSSL (Linux i686)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- armhf ---
    - name: Configure OpenSSL (Linux armhf)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: ./Configure linux-armv4 no-shared no-legacy --release --prefix=${{ github.workspace }}/install/linux/armhf CFLAGS="--target=arm-linux-gnueabihf"

    - name: Build & Install OpenSSL (Linux armhf)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      shell: bash
      run: |
        make -j$(nproc)
        make install_sw

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libraries-compiled-linux
        path: |
          install/**
        retention-days: 7

  build-libraries-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r29
        add-to-path: false

    - name: Download OpenSSL source
      id: download-openssl
      uses: ./.github/actions/download-openssl

    - name: Set NDK env
      run: |
        NDK_BIN="${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin"
        echo "NDK_BIN=$NDK_BIN" >> $GITHUB_ENV
        echo "NDK_TOOLCHAIN_ARGS=AR=$NDK_BIN/llvm-ar RANLIB=$NDK_BIN/llvm-ranlib STRIP=$NDK_BIN/llvm-strip" >> $GITHUB_ENV

    # --- arm64-v8a --- #C로만 컴파일되는 라이브러리
    - name: Configure OpenSSL (Android arm64-v8a)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        ./Configure linux-generic64 no-shared no-legacy --release \
          --prefix=${{ github.workspace }}/install/android/arm64-v8a \
          CC=$NDK_BIN/aarch64-linux-android35-clang \
          $NDK_TOOLCHAIN_ARGS

    - name: Build & Install OpenSSL (Android arm64-v8a)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- armeabi-v7a ---
    - name: Configure OpenSSL (Android armeabi-v7a)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        ./Configure linux-generic32 no-shared no-legacy --release \
          --prefix=${{ github.workspace }}/install/android/armeabi-v7a \
          CC=$NDK_BIN/armv7a-linux-androideabi35-clang \
          $NDK_TOOLCHAIN_ARGS

    - name: Build & Install OpenSSL (Android armeabi-v7a)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- x86_64 ---
    - name: Configure OpenSSL (Android x86_64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        ./Configure linux-generic64 no-shared no-legacy --release \
          --prefix=${{ github.workspace }}/install/android/x86_64 \
          CC=$NDK_BIN/x86_64-linux-android35-clang \
          $NDK_TOOLCHAIN_ARGS

    - name: Build & Install OpenSSL (Android x86_64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- x86 ---
    - name: Configure OpenSSL (Android x86)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        ./Configure linux-generic32 no-shared no-legacy --release \
          --prefix=${{ github.workspace }}/install/android/x86 \
          CC=$NDK_BIN/i686-linux-android35-clang \
          $NDK_TOOLCHAIN_ARGS

    - name: Build & Install OpenSSL (Android x86)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        make -j$(nproc)
        make install_sw
        make clean

    # --- riscv64 ---
    - name: Configure OpenSSL (Android riscv64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        ./Configure linux-generic64 no-shared no-legacy --release \
          --prefix=${{ github.workspace }}/install/android/riscv64 \
          CC=$NDK_BIN/riscv64-linux-android35-clang \
          $NDK_TOOLCHAIN_ARGS

    - name: Build & Install OpenSSL (Android riscv64)
      working-directory: openssl-${{ steps.download-openssl.outputs.openssl_version }}
      run: |
        make -j$(nproc)
        make install_sw

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libraries-compiled-android
        path: |
          install/**
        retention-days: 7

  create-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-libraries-linux, build-libraries-android, build-libraries-windows, build-libraries-windows-arm64]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Get version
      uses: actions/github-script@v7
      id: get-version
      with:
        script: |
          const version = context.ref.replace('refs/tags/v', '');
          core.setOutput('version', version);

    - name: Prepare release directory
      run: |
        mkdir -p release
        cp -r artifacts/libraries-compiled-linux release/linux
        cp -r artifacts/libraries-compiled-android release/android
        cp -r artifacts/libraries-windows release/windows
        cp -r artifacts/libraries-windows-arm64 release/windows-arm64

    - name: Create tar archive
      working-directory: release
      run: tar -czf ../libraries-${{ steps.get-version.outputs.version }}.tar.gz .

    - name: Create zip archive
      working-directory: release
      run: zip -r ../libraries-${{ steps.get-version.outputs.version }}.zip .

    - name: Create Release
      uses: softprops/action-gh-release@v2.5.0
      with:
        files: |
          libraries-*.tar.gz
          libraries-*.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}